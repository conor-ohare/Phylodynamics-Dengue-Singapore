# Phylogeographic Insights into the Dengue Outbreak in Singapore: Tracing Origins and Predicting Spread through High-Throughput Sequencing

This script generates files used for phylogenetic/dynamic/geographic analysis using the BEAST software. The data is omitted, but is available on my OneDrive (can place elsewhere if there is a particular preference). 

## Data

The sequencing data is sourced from NEA Singapore. This includes samples for the four dengue serotypes, between the years 2013 and 2022, with its corresponding metadata that includes location, receipt-date, genotype, etc. In the `data` folder (available on my OneDrive), there are the following folders:

- A folder for each serotype, containing the fasta file of all sequences of said serotype, and a csv metadata file
- Case distribution information - cases per year, and per month
- Reference sequences (with corresponding metadata), one per year (2012-2022) and per serotype

as well as the sequence fasta file for all samples and metadata.

Place this data folder in the cloned repository for use.

## Other files/folders

- The MAPLE software used in the relatively fast creation of a tree given a set of sequences and a reference
- A project folder, where all analyses end up in their respective folders (projects will have a time-stamped name). This has the following form:

```
.
├── DESCRIPTION.md
├── beast
│   ├── modified_beast_template-input_sequences.trees
│   ├── modified_beast_template.log
│   ├── modified_beast_template.xml
│   ├── modified_beast_template.xml.0state
│   ├── modified_beast_template.xml.1state
│   ├── modified_beast_template.xml.2state
│   ├── modified_beast_template.xml.3state
│   └── modified_beast_template.xml.state
├── beauti
│   ├── districts.txt
│   ├── input_sequences.fasta
│   └── sampleDates.txt
├── dengue_samples.metadata.csv
├── project_samples.MAPLE
│   ├── project_samples.MAPLE_input.txt
│   ├── project_samples.MAPLE_output_subs.txt
│   ├── project_samples.MAPLE_output_tree.tree
│   └── project_samples.aligned.fasta
├── project_samples.fasta
├── reference.fasta
└── tfpscanner
    ├── MAPLE_trees
    ├── beast_trees
    ├── tfp_clade_sizes.csv
    ├── tfp_growth_rates.csv
    ├── tfpscan-[date]
    └── tfpscanner_traits.csv
```
To generate this project folder, one must run `phylo_file_generation.py`, using specified filters applied to the entire dataset - e.g. range of years, district origin, etc - that one can change at the top of the script. 

A thorough description of the contents:
    - A description md file which lists the filters applied
    - Filtered sequence fasta file (with metadata)
    - Reference file selected (choose the year from 2012 to 2022)
    - Folder containing generated MAPLE files (aligned sequences to reference, tree-file, substitution matrix, and input MAPLE file for tree generation)
    - BeaUTi input files - district traits, time of samples, and the input fasta file
    - BEAST - log, trees, and other relevant files after performing BEAST on the entire specified dataset using the prior of choice
    - tfpscanner inputs - set of trees that all begin from the reference sequence start date. Each subsequent tree is expanded according to the specified number of months the window should increase by. Trees are generated by MAPLE and BEAST. Running the analysis, the clade sizes and growth rates are measured over each tree iteration.

## Running the programme

At the top of `phylo_file_generation.py`, you need to define the filter criteria. This can be the required years, sample origin, etc. Have a look at the headers of the metadata, and select the required values. If multiple required, include as a list.

Also select the year you want the reference from. Generally, we take the reference to be the year before the earliest selected sample. The programme will automatically choose the serotype corresponding to the most prevalent serotype in the filtered dataset. 

If performing BEAST or tfpscanner, again choose the appropriate parameter values.

If you have already generated a project file, and just want to do tfpscanner analysis, write the name of the folder under the variable name `existing_project` at the top of the `phylo_file_generation.py` file. This saves you a lot of time. 

## Comments

The running of BEAST and MAPLE is now operational. A tree (plus subtrees over given window sizes) can easily be constructed after specifying the filters. The problem reamins in the tfpscanner analysis. One might encounter the error

```
Error in seq.default(1, length(nodes), by = report_freq) : 
  wrong sign in 'by' argument
Calls: <Anonymous> -> seq -> seq.default
```

This, to my knowledge, indicated that there are no clusters of the minimum size you specify. Setting it too low will give you too many 'non', uninformative clusters. I'd suggest playing around with the numbers and seeing when the analysis works. Again, to keep messing around with the same project, specify the `existing_project` name above.

You can see, if you run one job, that cluster sizes and growth rates are equal to NA for many (see `tfp_clade_sizes.csv` and `tfp_growth_rates.csv`). My thinking was that you can have a clade size, and with the growth rate, estimate the clade size for the next iteration, and so on. I also made the trees as building off of the previous one, because this is how I interpreted its usage in *Phylogenomic early warning signals for SARS-CoV-2 epidemic waves*. I believe it was suggested to have a rolling window. But I struggled with this idea, as how do you keep track of which clade is which? That depends on some naming convention tfpscanner takes which I cannot decipher. Adding on to the existing clades keeps the names consistent.  

## Future extensions

Obviously getting our growth rate analysis to work! 

If you do BEAST analysis, you can only select the prior. For additional tunings, you would need to adapt the xml file. Might go back to this later to make it more flexible. But I just wanted to get it up and running. 


